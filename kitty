-- Fixed Kitty Stomp FX

local module = {}
local var2_upvw = 0
local ReplicatedStorage_upvr = game.ReplicatedStorage

function module.RunStompFx(arg1, arg2, arg3, arg4)
	local os_time_result1 = os.time()
	if os_time_result1 - var2_upvw < 5 then return end
	var2_upvw = os_time_result1

	local clone_2 = ReplicatedStorage_upvr.KillFX[arg1].Stomp:Clone()
	clone_2.Parent = arg2
	clone_2:Play()

	local clone_upvr = ReplicatedStorage_upvr.KillFX.Kitty.Model:Clone()
	clone_upvr.Parent = workspace.Ignored.Animations
	game.Debris:AddItem(clone_upvr, 5)

	local any_LoadAnimation_result1_upvr = clone_upvr.AnimationController:LoadAnimation(clone_upvr.Animation)
	any_LoadAnimation_result1_upvr:Play()
	any_LoadAnimation_result1_upvr:AdjustSpeed(0.7)

	local var9_upvw
	var9_upvw = any_LoadAnimation_result1_upvr:GetMarkerReachedSignal("START"):Connect(function()
		clone_upvr.HumanoidRootPart.CFrame = CFrame.new(arg2.Parent.HumanoidRootPart.Position) * CFrame.new(0, 6, 0)

		-- FIXED: arg3 is victim character, arg4 is attacker (Player)
		-- Need attacker's character for positioning
		local attackerChar = arg4.Character or arg4:FindFirstChild("Character")
		if not attackerChar or not attackerChar:FindFirstChild("HumanoidRootPart") then
			warn("Kitty: Attacker character not found")
			return
		end

		clone_upvr.HumanoidRootPart.CFrame = CFrame.new(
			clone_upvr.HumanoidRootPart.Position, 
			Vector3.new(
				attackerChar.HumanoidRootPart.Position.X, 
				clone_upvr.HumanoidRootPart.Position.Y, 
				attackerChar.HumanoidRootPart.Position.Z
			)
		) * CFrame.Angles(0, 0, math.pi)

		local var11_upvw
		var11_upvw = any_LoadAnimation_result1_upvr:GetMarkerReachedSignal("FALL"):Connect(function()
			local clone_4 = ReplicatedStorage_upvr.KillFX.Lotus.FX:Clone()
			clone_4.Parent = workspace.Ignored.Animations
			clone_4.PrimaryPart.CFrame = CFrame.new(arg2.Position)
			clone_4.PrimaryPart.Sound:Play()
			game.Debris:AddItem(clone_4, 5)

			local clone_3 = game.ReplicatedStorage.Adicd.Shock:Clone()
			clone_3.Parent = workspace.Ignored.Animations
			clone_3.Color = Color3.fromRGB(255, 143, 207)
			clone_3.Position = arg2.Position
			game.TweenService:Create(clone_3, TweenInfo.new(2.5, Enum.EasingStyle.Linear, Enum.EasingDirection.In), {
				Orientation = Vector3.new(0, 200, 0);
				Position = arg2.Position;
				Size = clone_3.Size + Vector3.new(50, 5, 50);
				Transparency = 1;
			}):Play()
			game.Debris:AddItem(clone_3, 2.5)

			local clone = game.ReplicatedStorage.Adicd.Wind:Clone()
			clone.Parent = workspace.Ignored.Animations
			clone.Color = Color3.fromRGB(255, 143, 207)
			clone.Position = arg2.Position
			game.TweenService:Create(clone, TweenInfo.new(3, Enum.EasingStyle.Linear, Enum.EasingDirection.In), {
				Orientation = Vector3.new(0, -200, 0);
				Position = arg2.Position;
				Size = clone.Size + Vector3.new(30, 2, 30);
				Transparency = 1;
			}):Play()
			game.Debris:AddItem(clone, 3)

			-- Check attacker data folder for custom colors
			if arg4 and arg4:FindFirstChild("DataFolder") and arg4.DataFolder:FindFirstChild("Information") then
				for _, v in pairs(clone_4:GetDescendants()) do
					if v:IsA("BasePart") or v:IsA("MeshPart") then
						v.Color = Color3.fromRGB(255, 143, 207)
					end
				end
			end

			for _, v_2 in pairs(clone_4:GetChildren()) do
				local var31 = 1200
				if math.random(1, 2) == 2 then
					var31 = -1200
				end
				game:GetService("TweenService"):Create(v_2, TweenInfo.new(4), {
					Transparency = 1;
					Position = arg2.Position + Vector3.new(0, 2, 0);
					Size = v_2.Size + Vector3.new(200, 200, 200);
					Orientation = v_2.Orientation + Vector3.new(0, 0, var31);
				}):Play()
			end

			local var34_upvw
			var34_upvw = any_LoadAnimation_result1_upvr:GetMarkerReachedSignal("WINK"):Connect(function()
				clone_upvr.HumanoidRootPart.Meow:Play()
				clone_upvr.HumanoidRootPart.Wink:Play()
				game.TweenService:Create(clone_upvr.Wink, TweenInfo.new(0.5), {
					Size = Vector3.new(0.70499, 1.06099, 0.24500);
				}):Play()

				task.delay(0.5, function()
					game.TweenService:Create(clone_upvr.Wink, TweenInfo.new(0.5), {
						Size = Vector3.new(0.70499, 1.06099, 1.40999);
					}):Play()
				end)

				clone_upvr.Wink.Attachment.Winker.Enabled = true
				task.delay(0.2, function()
					clone_upvr.Wink.Attachment.Winker.Enabled = false
				end)

				any_LoadAnimation_result1_upvr:AdjustSpeed(1)
				clone_upvr.HumanoidRootPart.Roll:Play()
				for _, v_3 in pairs(clone_upvr:GetDescendants()) do
					if v_3:IsA("BasePart") then
						game.TweenService:Create(v_3, TweenInfo.new(1.5), {
							Transparency = 1;
						}):Play()
					end
				end

				var34_upvw:Disconnect()
			end)
			var11_upvw:Disconnect()
		end)
		var9_upvw:Disconnect()
	end)
	return nil
end

return module
